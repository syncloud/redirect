---
layout: default
title: User

main_menu_item: menu_user
styles: css/user.css
---

<div class="container">
  <div id="has_domains" style="display: none;">
    <h2>Devices</h2>
    <br/>
    <div id="domains">
    </div>
  </div>
  <div id="no_domains" style="display: none;">
    <div class="row">
      <div class="col-2 col-md-2 col-sm-2 col-lg-2"><span></span></div>
      <div class="col-8 col-md-8 col-sm-8 col-lg-8">
        <div class="jumbotron" style="margin: 40px">
          <h1>No Devices</h1>
          <p>You do not have any activated devices.<br/>Buy or build your first Syncloud device and activate it.</p>
            <br/>
          <p style="text-align:center;">
            <a class="btn btn-primary btn-lg" href="http://syncloud.org" role="button">Learn more</a>
          </p>
        </div>
      </div>
      <div class="col-2 col-md-2 col-sm-2 col-lg-2"><span></span></div>
    </div>
  </div>
</div>


<script type="text/html" id="domain_template">
<![CDATA[
  <% for (d=0; d < this.domains.length; d++) {
       var domain = this.domains[d]; %>

  <% if (d % 2 == 0) { %>
  <div class="row">
  <% } %>

    <div class="modal fade" id="modalDeactivateDomain_<%= d %>" tabindex="-1" role="dialog" aria-labelledby="modalDeactivateDomain_<%= d %>">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Deactivate <%= domain.user_domain %></h4>
          </div>
          <div class="modal-body">
            Device will be unlinked from the domain. Domain will be released and might be taken by other user. Proceed with caution!
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" onClick="domain_delete('<%= domain.user_domain %>');">Deactivate</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-6 col-sm-6 col-lg-6">
      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="panel-title">
            <h3 style="margin-top: 5px; margin-bottom: 5px">
                <span>
                    <%= domain.domain_name %>
                </span>
                <% if (domain.online) { %>
                <span class="pull-right circle_online"></span>
                <% } else { %>
                <span class="pull-right circle_offline"></span>
                <% } %>
            </h3>
          </div>
        </div>
        <ul class="list-group">
          <li class="list-group-item clearfix">
            <h3 class="pull-left" style="margin-top: 5px; margin-bottom: 5px"><%= domain.device_title %></h3>

            <button type="button" class="btn btn-default pull-right" data-toggle="modal" data-target="#modalDeactivateDomain_<%= d %>">
              <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Deactivate
            </button>

          </li>
          <li class="list-group-item clearfix">
              <span>Domain Address: </span>
              <% if (domain.has_domain_address) { %>
              <a href="<%= domain.domain_address %>"><%= domain.domain_address %></a>
              <% } else { %>
              <span>Not mapped</span>
              <% } %>
          </li>
          <li class="list-group-item clearfix">
              <span>External Address: </span>
              <% if (domain.has_external_address) { %>
              <a href="<%= domain.external_address %>"><%= domain.external_address %></a>
              <% } else { %>
              <span>Not provided</span>
              <% } %>
          </li>
          <li class="list-group-item clearfix">
              <span>Internal Address: </span>
              <% if (domain.has_internal_address) { %>
              <a href="<%= domain.internal_address %>"><%= domain.internal_address %></a>
              <% } else { %>
              <span>Not provided</span>
              <% } %>
          </li>
          <li class="list-group-item clearfix">
              <span>IPv6 Address: </span>
              <% if (domain.has_ipv6_address) { %>
              <a href="<%= domain.ipv6_address %>"><%= domain.ipv6_address %></a>
              <% } else { %>
              <span>Not provided</span>
              <% } %>
          </li>
          <li class="list-group-item clearfix">
              <span>Updated: <%= domain.nice_last_update %></span>
          </li>
        </ul>
      </div>
    </div>

  <% if (d % 2 == 1 || d == this.domains.length - 1) { %>
  </div>
  <% } %>
  <% } %>
]]>
</script>

<script type="text/javascript">

function sameDay(date1, date2) {
    var isSameDay = (date1.getDate() == date2.getDate()
                     && date1.getMonth() == date2.getMonth()
                     && date1.getFullYear() == date2.getFullYear());
    return isSameDay;
}

function online(ds) {
    if (ds === null) {
      return false;
    }

    var diff = new Date() - new Date(Date.parse(ds));
    var minutes = Math.floor((diff/1000)/60);

    return minutes < 10;
}

function niceTimestamp(ds) {
    if (ds === null) {
      return "never";
    }
    var d = new Date(Date.parse(ds));
    var today = new Date();
    var isSameDay = sameDay(today, d);
    var date_format = "MMM d, yyyy";
    if (isSameDay) {
        date_format = "'Today' hh:mm";
    }
    return $.format.date(d, date_format);
}

function fullUrl(address, port) {
    var result = "https://"+address;
    if (port !== 443)
        result = result+":"+port;
    return result;
}

function prepareUserData(user) {
    for (di = 0; di < user.domains.length; ++di) {
        var domain = user.domains[di];

        domain.domain_name = domain.user_domain + "." + redirect.main_domain;

        domain.domain_address_port = domain.map_local_address ? domain.web_local_port : domain.web_port;

        domain.domain_address = fullUrl(domain.domain_name, domain.domain_address_port);
        domain.has_domain_address = domain.domain_name !== null;

        domain.external_address = fullUrl(domain.ip, domain.web_port);
        domain.has_external_address = domain.ip !== null;

        domain.internal_address = fullUrl(domain.local_ip, domain.web_local_port);
        domain.has_internal_address = domain.local_ip !== null;

        domain.ipv6_address = fullUrl("[" + domain.ipv6 + "]", domain.web_local_port);
        domain.has_ipv6_address = domain.ipv6 !== null;

        domain.online = online(domain.last_update);
        domain.nice_last_update = niceTimestamp(domain.last_update);
    }
}

function domain_delete(user_domain) {
    var posting = $.post(redirect.web("domain_delete"), { "user_domain": user_domain })
        .done( function(data) {
            window.location.reload();
        })
        .fail( function(xhr, textStatus, errorThrown) {
            var error = xhr.responseJSON;
        });
}

$( document ).ready(function() {

    var url = redirect.web("user")

    var getting = $.get( url )
        .done( function(data) {
            var user = data;

            if (user.domains.length > 0) {
                $('#has_domains').show();
                $('#no_domains').hide();

                prepareUserData(user);
                $('#domains').append($('#domain_template').jqote(user));
            } else {
                $('#has_domains').hide();
                $('#no_domains').show();
            }
        })
        .fail( function(xhr, textStatus, errorThrown) {
            if (xhr.status === 401) {
                window.location.href = "login.html";
            } else {
                window.location.href = "error.html";
            }
        });
});
</script>
