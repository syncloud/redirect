---
layout: default
title: User

main_menu_item: menu_user
styles: css/user.css
---

<div class="container">
  <div id="has_domains" style="display: none;">
    <h2>Devices</h2>
    <br/>
    <div id="domains">
    </div>
  </div>
  <div id="no_domains" style="display: none;">
    <div class="row">
      <div class="col-2 col-md-2 col-sm-2 col-lg-2"><span/></div>
      <div class="col-8 col-md-8 col-sm-8 col-lg-8">
        <div class="jumbotron" style="margin: 40px">
          <h1>No Devices</h1>
          <p>You do not have any activated devices.<br/>Buy or build your first Syncloud device and activate it.</p>
            <br/>
          <p style="text-align:center;">
            <a class="btn btn-primary btn-lg" href="http://syncloud.org" role="button">Learn more</a>
          </p>
        </div>
      </div>
      <div class="col-2 col-md-2 col-sm-2 col-lg-2"><span/></div>
    </div>
  </div>
</div>

<script type="text/html" id="domain_template">
<![CDATA[
  <% for (d=0; d < this.domains.length; d++) {
       var domain = this.domains[d]; %>

  <% if (d % 2 == 0) { %>
  <div class="row">
  <% } %>

    <div class="col-6 col-md-6 col-sm-6 col-lg-6">
      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="panel-title">
            <h3 style="margin-top: 5px; margin-bottom: 5px">
                <span>
                    <%= domain.domain_name %>
                </span>
                <% if (domain.online) { %>
                <div id="circle_online" class="pull-right"></div>
                <% } else { %>
                <div id="circle_offline" class="pull-right"></div>
                <% } %>
            </h3>
          </div>
        </div>
        <ul class="list-group">
          <li class="list-group-item clearfix">
            <h3 class="pull-left" style="margin-top: 5px; margin-bottom: 5px"><%= domain.device_title %></h3>
            <button type="button" class="btn btn-default pull-right" onClick="domain_delete('<%= domain.user_domain %>');">
              <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Deactivate
            </button>
          </li>
          <li class="list-group-item clearfix">
              <span>Domain Address: </span>
              <% if (domain.has_domain_address) { %>
              <a href="<%= domain.domain_address %>"><%= domain.domain_address %></a>
              <% } else { %>
              <span>Not mapped</span>
              <% } %>
          </li>
          <li class="list-group-item clearfix">
              <span>External Address: </span>
              <% if (domain.has_external_address) { %>
              <a href="<%= domain.external_address %>"><%= domain.external_address %></a>
              <% } else { %>
              <span>Not provided</span>
              <% } %>
          </li>
          <li class="list-group-item clearfix">
              <span>Internal Address: </span>
              <% if (domain.has_internal_address) { %>
              <a href="<%= domain.internal_address %>"><%= domain.internal_address %></a>
              <% } else { %>
              <span>Not provided</span>
              <% } %>
          </li>
          <li class="list-group-item clearfix">
              <span>Updated: <%= domain.nice_last_update %></span>
          </li>
        </ul>
      </div>
    </div>

  <% if (d % 2 == 1 || d == this.domains.length - 1) { %>
  </div>
  <% } %>
  <% } %>
]]>
</script>

<script type="text/javascript">

function serverService(domain) {
    for (si = 0; di < domain.services.length; si++) {
        var service = domain.services[di];
        if (service.name === "server") {
            return service;
        }
    }
    return null;
}

function sameDay(date1, date2) {
    var isSameDay = (date1.getDate() == date2.getDate()
                     && date1.getMonth() == date2.getMonth()
                     && date1.getFullYear() == date2.getFullYear());
    return isSameDay;
}

function online(ds) {
    if (ds === null) {
      return false;
    }

    var diff = new Date() - new Date(Date.parse(ds));
    var minutes = Math.floor((diff/1000)/60);

    return minutes < 10;
}

function niceTimestamp(ds) {
    if (ds === null) {
      return "never";
    }
    var d = new Date(Date.parse(ds));
    var today = new Date();
    var isSameDay = sameDay(today, d);
    var date_format = "MMM d, yyyy";
    if (isSameDay) {
        date_format = "'Today' hh:mm";
    }
    return $.format.date(d, date_format);
}

function fullUrl(protocol, address, port, url) {
    if (protocol === null || address === null || port === null) {
        return null;
    }
    var result = protocol+"://"+address;
    if (port !== 80)
        result = result+":"+port;
    if (url !== null)
        result = result+"/"+url;
    return result;
}

function prepareUserData(user) {
    for (di = 0; di < user.domains.length; ++di) {
        var domain = user.domains[di];

        var server = serverService(domain);
        if (server !== null) {
            domain.protocol = server.protocol;
            domain.port = server.port;
            domain.local_port = server.local_port;
            domain.url = server.url;
        } else {
            domain.protocol = null
            domain.port = null;
            domain.local_port = null;
            domain.url = null;
        }
        domain.domain_name = domain.user_domain + "." + redirect.main_domain;

        domain.domain_address_port = domain.map_local_address ? domain.local_port : domain.port;

        domain.domain_address = fullUrl(domain.protocol, domain.domain_name, domain.domain_address_port, domain.url);
        domain.has_domain_address = domain.domain_address !== null;

        domain.external_address = fullUrl(domain.protocol, domain.ip, domain.port, domain.url);
        domain.has_external_address = domain.external_address !== null;

        domain.internal_address = fullUrl(domain.protocol, domain.local_ip, domain.local_port, domain.url);
        domain.has_internal_address = domain.internal_address !== null;

        domain.online = online(domain.last_update);
        domain.nice_last_update = niceTimestamp(domain.last_update);
    }
}

function domain_delete(user_domain) {
    var posting = $.post(redirect.web("domain_delete"), { "user_domain": user_domain })
        .done( function(data) {
            window.location.reload();
        })
        .fail( function(xhr, textStatus, errorThrown) {
            var error = xhr.responseJSON;
        });
}

$( document ).ready(function() {

    var url = redirect.web("user")

    var getting = $.get( url )
        .done( function(data) {
            var user = data;

            if (user.domains.length > 0) {
                $('#has_domains').show();
                $('#no_domains').hide();

                prepareUserData(user);
                $('#domains').append($('#domain_template').jqote(user));
            } else {
                $('#has_domains').hide();
                $('#no_domains').show();
            }
        })
        .fail( function(xhr, textStatus, errorThrown) {
            if (xhr.status === 401) {
                window.location.href = "login.html";
            } else {
                window.location.href = "error.html";
            }
        });
});
</script>
