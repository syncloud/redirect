#!/bin/bash -e

if [[ -z "$2" ]]; then
    echo "usage $0 version env"
    exit 1
fi

VERSION=$1
ENV=$2

TARGET=/var/www/redirect/${VERSION}
CURRENT=/var/www/redirect/current

mkdir -p ${TARGET}
tar xf redirect-${VERSION}.tar.gz -C ${TARGET}
rm -f ${CURRENT}
ln -s ${TARGET} ${CURRENT}
sudo pip install -r ${CURRENT}/requirements.txt
cp -rf ${CURRENT}/config/${ENV}/* ${CURRENT}
cp ${CURRENT}/apache/redirect.conf /etc/apache2/sites-available
sudo adduser --disabled-password --gecos "" test
sudo chown -R redirect. ${CURRENT}
sudo a2dissite 000-default.conf
s2ensite redirect.conf
sudo nano /etc/apache2/envvars
sed -i 's/SYNCLOUD_DOMAIN.*/d'
export SYNCLOUD_DOMAIN=syncloud.it
sudo service apache2 restart
