# Set these lines to apache evnvars
# export SYNCLOUD_DOMAIN=...
# export SYNCLOUD_ENV=...

<VirtualHost *:80>

    ServerName ${SYNCLOUD_DOMAIN}
    ServerAlias www.${SYNCLOUD_DOMAIN}

    Redirect / https://${SYNCLOUD_DOMAIN}/

</VirtualHost>

<VirtualHost *:80>

    ServerName api.${SYNCLOUD_DOMAIN}
    ServerAlias *.${SYNCLOUD_DOMAIN}

    DocumentRoot /var/www/redirect-${SYNCLOUD_ENV}/www/_site                          
    Alias "/.well-known" "/var/www/redirect-${SYNCLOUD_ENV}/www/_site/.well-known"

    WSGIScriptAlias / /var/www/redirect-${SYNCLOUD_ENV}/redirect_rest.wsgi
    WSGIDaemonProcess redirect_rest user=redirect group=redirect threads=5

    <Directory /var/www/redirect-${SYNCLOUD_ENV}>
        WSGIProcessGroup redirect_rest
        WSGIApplicationGroup %{GLOBAL}
        Order deny,allow
        Allow from all
    </Directory>

    CustomLog ${APACHE_LOG_DIR}/redirect_rest-access.log combined
    ErrorLog ${APACHE_LOG_DIR}/redirect_rest-error.log

</VirtualHost>

<VirtualHost *:443>

    ServerName ${SYNCLOUD_DOMAIN}
    ServerAlias www.${SYNCLOUD_DOMAIN}

    DocumentRoot /var/www/redirect-${SYNCLOUD_ENV}/www/_site

    SSLEngine on
    SSLCertificateFile "/etc/letsencrypt/live/${SYNCLOUD_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "/etc/letsencrypt/live/${SYNCLOUD_DOMAIN}/privkey.pem"

    WSGIScriptAlias /api /var/www/redirect-${SYNCLOUD_ENV}/redirect_web.wsgi
    WSGIDaemonProcess redirect_ssl_web user=redirect group=redirect threads=5

    <Directory /var/www/redirect-${SYNCLOUD_ENV}>
        WSGIProcessGroup redirect_ssl_web
        WSGIApplicationGroup %{GLOBAL}
        Order deny,allow
        Allow from all
        DirectoryIndex login.html
    </Directory>

    CustomLog ${APACHE_LOG_DIR}/redirect_ssl_web-access.log combined
    ErrorLog ${APACHE_LOG_DIR}/redirect_ssl_web-error.log

</VirtualHost>

<VirtualHost *:443>

    ServerName api.${SYNCLOUD_DOMAIN}
    ServerAlias *.${SYNCLOUD_DOMAIN}

    DocumentRoot /var/www/redirect-${SYNCLOUD_ENV}/www/_site 

    SSLEngine on
    SSLCertificateFile "/etc/letsencrypt/live/${SYNCLOUD_DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "/etc/letsencrypt/live/${SYNCLOUD_DOMAIN}/privkey.pem"

    Alias "/.well-known" "/var/www/redirect-${SYNCLOUD_ENV}/www/_site/.well-known"

    WSGIScriptAlias / /var/www/redirect-${SYNCLOUD_ENV}/redirect_rest.wsgi
    WSGIDaemonProcess redirect_ssl_rest user=redirect group=redirect threads=5

    <Directory /var/www/redirect-${SYNCLOUD_ENV}>
        WSGIProcessGroup redirect_ssl_rest
        WSGIApplicationGroup %{GLOBAL}
        Order deny,allow
        Allow from all
    </Directory>

    CustomLog ${APACHE_LOG_DIR}/redirect_ssl_rest-access.log combined
    ErrorLog ${APACHE_LOG_DIR}/redirect_ssl_rest-error.log

</VirtualHost>